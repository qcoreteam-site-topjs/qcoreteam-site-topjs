<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>loader/StandardLoader.js - Documentation</title>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="../css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="../css/prettify.css">
    <link type="text/css" rel="stylesheet" href="../css/jsdoc.css">
    <link type="text/css" rel="stylesheet" href="../css/extra.css">
    <link type="text/css" rel="stylesheet" href="../css/common.css">
</head>
<body>
<header class="navbar navbar-fixed-top fixed-header fixed-header-active header hidden-sm-down">
    <nav class="navbar navbar-light">

        <div class="">
            <button class="navbar-toggler hidden-lg-up float-xs-right" type="button" data-toggle="collapse"
                    data-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"></button>
            <a href="/"><img class="navbar-brand logo" src="../images/logo-green.png"></a>

            <div class="collapse navbar-toggleable-md float-lg-right" id="navbarResponsive">
                <ul class="nav navbar-nav float-lg-right">
                    <li class="nav-item"><a class="nav-link" href="/" >首页</a></li><li class="nav-item"><a class="nav-link" href="/docs/v0.0.1/" >手册</a></li><li class="nav-item"><a class="nav-link" href="/api/" >API文档</a></li><li class="nav-item"><a class="nav-link" href="/categories/blog/" >博客</a></li><li class="nav-item"><a class="nav-link" href="/categories/devel/" >开发日志</a></li><li class="nav-item"><a class="nav-link" href="/about/" >关于我们</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="hidden-md-up sm-header">
    <div class="toggler" id="slideClose"></div>
    <img src="../images/logo-green.png">
</div>
<div class="api-container clearfix">
    <nav>
        <div class="category hidden-md-up">
            <a href="/">首页</a>
            <a href="/docs/v0.0.1/">手册</a>
            <a href="/api/">API文档</a>
            <a href="/categories/blog">博客</a>
            <a href="/categories/devel">开发日志</a>
            <a href="/about">关于我们</a>
        </div>
        <h3>Namespaces</h3><ul class = "entry-type-namespaces"><li><a href="TopJs.html">TopJs</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.Array.html">Array</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Assert.html">Assert</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Base.html">Base</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Class.html">Class</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.ClassManager.html">ClassManager</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Config.html">Config</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Date.html">Date</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Error.html">Error</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Function.html">Function</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Loader.html">Loader</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Number.html">Number</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Object.html">Object</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.String.html">String</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Version.html">Version</a></li></ul></li><li><a href="TopJs.kernel.html">TopJs.kernel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#callParent">callParent</a></li><li><a href="global.html#callSuper">callSuper</a></li><li><a href="global.html#clearPropertiesOnDestroy">clearPropertiesOnDestroy</a></li><li><a href="global.html#destroyed">destroyed</a></li><li><a href="global.html#isConfiguring">isConfiguring</a></li><li><a href="global.html#isFirstInstance">isFirstInstance</a></li><li><a href="global.html#isInstance">isInstance</a></li><li><a href="global.html#statics">statics</a></li></ul>
    </nav>
    <div id="main">
        
        <h1 class="page-title">loader/StandardLoader.js</h1>
        

        



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
/*
 * TopJs Framework (http://www.topjs.org/)
 *
 * @link      http://github.com/qcoreteam/topjs for the canonical source repository
 * @copyright Copyright (c) 2016-2017 QCoreTeam (http://www.qcoreteam.org)
 * @license   http://www.topjs.org/license/new-bsd New BSD License
 */

import {is_object, in_array, rtrim, is_string, change_str_at, file_exist} from '../internal/Funcs';
import {sep as dir_separator, dirname} from 'path';
import {stat, statSync} from 'fs';
import Namespace from "./Namespace";
import path from "path"

/**
 * 标准自动加载器
 * &lt;font color="red">注意，这个类为底层自动加载类，一般只在入口文件进行实例化。&lt;/font>
 * ```javascript
 *
 *    let loader = new StandardLoader({
 *       [StandardLoader.AUTO_REGISTER_TOPJS] : true
 *    });
 *    loader.register();
 *
 * ```
 * @class TopJs.Loader
 * @singleton
 */
let Loader = TopJs.Loader = {};

TopJs.apply(Loader, /** @lends TopJs.Loader */{
    /**
     * @readonly
     * @static
     * @property {string} NS_SEPARATOR 名称空间分隔符
     */
    NS_SEPARATOR: ".",
    /**
     * @readonly
     * @static
     * @property {string} LOAD_NS 参数批量设置的时候名称空间项识别码常量
     */
    LOAD_NS: "namespaces",

    /**
     * @readonly
     * @static
     * @property {string} NAMESPACE_ACCESSOR_KEY 对象代理访问时候获取名称空间对象的特殊键名
     */
    NAMESPACE_ACCESSOR_KEY: "__NAMESPACE_ACCESSOR_KEY__",

    /**
     * @protected
     * @property {Map[]} namespaces 名称空间到类的文件夹之间的映射
     */
    namespaces: new Map(),

    /**
     * @protected
     * @property {boolean} registered 是否已经注册过，一个loader只能注册一次
     */
    registered: false,

    /**
     * @protected
     * @property {Map} proxyCache proxy对象的缓存
     */
    proxyCache: new Map(),

    /**
     * 注册一个名称空间到对应文件夹的映射项
     *
     * @param {string} namespace
     * @param {string} directory
     * @returns {TopJs.Loader}
     */
    registerNamespace(namespace, directory)
    {
        let sep = Loader.NS_SEPARATOR;
        namespace = rtrim(namespace, sep);
        let parts = namespace.split(sep);
        let nsObj;
        if (this.namespaces.has(parts[0])) {
            nsObj = this.namespaces.get(parts[0]);
        } else {
            nsObj = new Namespace(parts[0], null, null);
            this.namespaces.set(parts[0], nsObj);
        }
        //子名称空间
        for (let i = 1; i &lt; parts.length; i++) {
            let childNsObj = nsObj.getChildNamespace(parts[i]);
            if (null === childNsObj) {
                nsObj = new Namespace(parts[i], nsObj, null);
            } else {
                nsObj = childNsObj;
            }
        }
        try {
            nsObj.setDirectory(this.normalizeDirectory(directory));
        } catch (err) {}
        return nsObj;
    },

    /**
     * 一次性注册多个名称空间到文件目录的映射, `namespace`参数结构如下：
     * ```javascript
     * {
         *    namespace1: dir1,
         *    namespace2: dir2,
         *    ...
         * }
     * ```
     *
     * @param {Object} namespaces 需要注册的名称空间类型
     * @returns {TopJs.Loader}
     */
    registerNamespaces(namespaces)
    {
        if (!is_object(namespaces)) {
            throw new Error('arg namespaces must be object');
        }
        for (let [namespace, direcotry] of Object.entries(namespaces)) {
            this.registerNamespace(namespace, direcotry);
        }
        return this;
    },

    /**
     * 通过名称空间名称，获取底层名称空间对象引用
     *
     * @param {Object} name 名称空间的名称
     * @returns {TopJs.Namespace}
     */
    getNamespace(name)
    {
        let parts = name.split(Loader.NS_SEPARATOR);
        let ns;
        if (!this.namespaces.has(parts[0])) {
            return null;
        }
        ns = this.namespaces.get(parts[0]);
        for (let i = 1; i &lt; parts.length; i++) {
            ns = ns.getChildNamespace(parts[i]);
            if (null == ns) {
                break;
            }
        }
        return ns;
    },

    require(fullClsName)
    {
        let parts = fullClsName.split(".");
        let clsName = parts.pop();
        let ns = parts.join(".");
        let nsObject = this.createNamespace(ns);
        try {
            let filename = path.resolve(nsObject.directory, `${clsName}.js`);
            let stats = statSync(filename);
            if (stats.isFile()) {
                let Cls = require(filename);
                // 支持加载普通的类
                // 通过TopJs.define定义的类自动操作名称空间
                if (!nsObject.children.has(clsName)) {
                    nsObject.children.set(clsName, Cls);
                    return Cls;
                }
            }
        } catch (err) {
            if ("ENOENT" === err.code) {
                let filename = nsObject.directory + `${clsName}.js`;
                err.message = `require: class file ${filename} not exist`;
            }
            throw err;
        }
    },

    /**
     * @param {String} namespace 名称空间的字符串描述
     * @return {Namespace}
     */
    createNamespace(namespace)
    {
        let parts = namespace.split(Loader.NS_SEPARATOR);
        let ns;
        let nsDir;
        let partName;
        let parentNs;
        if (!this.namespaces.has(parts[0])) {
            return null;
        }
        ns = this.namespaces.get(parts[0]);
        for (let i = 1; i &lt; parts.length; i++) {
            partName = parts[i];
            nsDir = ns.directory;
            parentNs = ns;
            ns = ns.getChildNamespace(partName);
            if (null == ns) {
                //判断文件夹是否存在
                try {
                    let filename = path.resolve(nsDir, partName);
                    let stats = statSync(filename);
                    if (stats.isDirectory()) {
                        ns = new Namespace(partName, parentNs, filename);
                    }
                } catch (err) {
                    if ("ENOENT" === err.code) {
                        let dir = nsDir + dir_separator + partName;
                        err.message = `create namespace error: directory ${dir} not exist`;
                    }
                    throw err;
                }
            }
        }
        return ns;
    },
    
    /**
     * 格式化加载目录，主要就是在路径的末尾加上路径分隔符
     *
     * @protected
     * @param {string} directory 需要进行处理的文件夹路径
     * @return {string}
     */
    normalizeDirectory(directory)
    {
        let len = directory.length;
        let last = directory.charAt(len - 1);
        if (in_array(last, ["/", "\\"])) {
            return change_str_at(directory, len - 1, dir_separator);
        }
        directory += dir_separator;
        return directory;
    },

    /**
     * 将类的全名转换成名称空间对应的文件夹路径
     *
     * @param {string} fullClsName 带名称空间的类的名称
     * @param {string} [dir=process.cwd()] 起点文件夹路径
     * @returns {string}
     */
    transformClassNameToFilenameByNamespace(fullClsName, dir = process.cwd())
    {
        let parts = fullClsName.split(".");
        let clsName = parts.pop();
        let ns = parts.join(".");
        let nsObj = null;
        let midParts = [];
        while (!(nsObj = this.getNamespace(ns)) &amp;&amp; parts.length > 0) {
            midParts.push(parts.pop());
            ns = parts.join(".");
        }
        if (nsObj) {
            dir = nsObj.directory;
        }
        dir = this.normalizeDirectory(dir);
        if (midParts.length > 0) {
            dir += midParts.join(dir_separator) + dir_separator;
        }
        return dir + clsName + '.js'
    }
});

/**
 * 加载指定的类
 * @method
 */
TopJs.require = TopJs.Function.alias(Loader, 'require');</code></pre>
        </article>
    </section>




    </div>
</div>



<script src="../js/jquery.min.js"></script>
<script src="../js/tether.min.js" crossorigin="anonymous"></script>

<script src="../js/prettify/prettify.js"></script>
<script src="../js/prettify/lang-css.js"></script>
<script>prettyPrint();</script>

<script src="../js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="../js/linenumber.js"></script>
<script src="../js/maodian.js"></script>

<script src="../js/extra.js"></script>
<script src="../js/common.js"></script>
</body>
</html>
