<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>servicemanager/ServiceManager.js - Documentation</title>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="../css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="../css/jsdoc.css">
    <link type="text/css" rel="stylesheet" href="../css/extra.css">
    <link type="text/css" rel="stylesheet" href="../css/common.css">
    <link type="text/css" rel="stylesheet" href="../css/highlight.css">
</head>
<body>
<header class="navbar navbar-fixed-top fixed-header fixed-header-active header hidden-sm-down">
    <nav class="navbar navbar-light">

        <div class="">
            <button class="navbar-toggler hidden-lg-up float-xs-right" type="button" data-toggle="collapse"
                    data-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"></button>
            <a href="/"><img class="navbar-brand logo" src="../images/logo-green.png"></a>

            <div class="collapse navbar-toggleable-md float-lg-right" id="navbarResponsive">
                <ul class="nav navbar-nav float-lg-right">
                    <li class="nav-item"><a class="nav-link" href="/" >首页</a></li><li class="nav-item"><a class="nav-link" href="/docs/v0.0.1/" >手册</a></li><li class="nav-item"><a class="nav-link" href="/api/" >API文档</a></li><li class="nav-item"><a class="nav-link" href="/categories/blog/" >博客</a></li><li class="nav-item"><a class="nav-link" href="/categories/devel/" >开发日志</a></li><li class="nav-item"><a class="nav-link" href="/about/" >关于我们</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="hidden-md-up sm-header">
    <div class="toggler" id="slideClose"></div>
    <img src="../images/logo-green.png">
</div>
<div class="api-container clearfix">
    <nav>
        <div class="category hidden-md-up">
            <a href="/">首页</a>
            <a href="/docs/v0.0.1/">手册</a>
            <a href="/api/">API文档</a>
            <a href="/categories/blog">博客</a>
            <a href="/categories/devel">开发日志</a>
            <a href="/about">关于我们</a>
        </div>
        <h3>Namespaces</h3><ul class = "entry-type-namespaces"><li><a href="TopJs.html" class="show-member-names">TopJs</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.Array.html" class="show-member-names">Array</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Assert.html" class="show-member-names">Assert</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Date.html" class="show-member-names">Date</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Error.html" class="show-member-names">Error</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Function.html" class="show-member-names">Function</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Loader.html" class="show-member-names">Loader</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Number.html" class="show-member-names">Number</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Object.html" class="show-member-names">Object</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.String.html" class="show-member-names">String</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Version.html" class="show-member-names">Version</a></li></ul></li><li><a href="TopJs.code.html" class="show-member-names">TopJs.code</a></li><li><a href="TopJs.code.generator.html" class="show-member-names">TopJs.code.generator</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.code.generator.AbstractGenerator.html" class="show-member-names">AbstractGenerator</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.code.generator.GeneratorInterface.html" class="show-member-names">GeneratorInterface</a></li></ul></li><li><a href="TopJs.eventmanager.html" class="show-member-names">TopJs.eventmanager</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.eventmanager.Callable.html" class="show-member-names">Callable</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.eventmanager.EventManagerAwareInterface.html" class="show-member-names">EventManagerAwareInterface</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.eventmanager.EventManagerAwareTrait.html" class="show-member-names">EventManagerAwareTrait</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.eventmanager.EventsCapableInterface.html" class="show-member-names">EventsCapableInterface</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.eventmanager.FilterInterface.html" class="show-member-names">FilterInterface</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.eventmanager.ResponseCollection.html" class="show-member-names">ResponseCollection</a></li></ul></li><li><a href="TopJs.eventmanager.filter.html" class="show-member-names">TopJs.eventmanager.filter</a></li><li><a href="TopJs.kernel.html" class="show-member-names">TopJs.kernel</a></li><li><a href="TopJs.psr.html" class="show-member-names">TopJs.psr</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.psr.ContainerInterface.html" class="show-member-names">ContainerInterface</a></li></ul></li><li><a href="TopJs.servicemanager.html" class="show-member-names">TopJs.servicemanager</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.servicemanager.ConfigInterface.html" class="show-member-names">ConfigInterface</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.servicemanager.ServiceLocatorInterface.html" class="show-member-names">ServiceLocatorInterface</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.servicemanager.ServiceManager.html" class="show-member-names">ServiceManager</a></li></ul></li><li><a href="TopJs.servicemanager.factory.html" class="show-member-names">TopJs.servicemanager.factory</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.servicemanager.factory.AbstractFactoryInterface.html" class="show-member-names">AbstractFactoryInterface</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.servicemanager.factory.DelegatorFactoryInterface.html" class="show-member-names">DelegatorFactoryInterface</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.servicemanager.factory.FactoryInterface.html" class="show-member-names">FactoryInterface</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.servicemanager.factory.InvokableFactory.html" class="show-member-names">InvokableFactory</a></li></ul></li><li><a href="TopJs.servicemanager.initializer.html" class="show-member-names">TopJs.servicemanager.initializer</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.servicemanager.initializer.InitializerInterface.html" class="show-member-names">InitializerInterface</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#compare">compare</a></li><li><a href="global.html#LINE_FEED">LINE_FEED</a></li><li><a href="global.html#MAX">MAX</a></li><li><a href="global.html#MIN">MIN</a></li></ul>
    </nav>
    <div id="main">
        
        <h1 class="page-title">servicemanager/ServiceManager.js</h1>
        

        



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
/*
 * TopJs Framework (http://www.topjs.org/)
 *
 * @link      http://github.com/qcoreteam/topjs for the canonical source repository
 * @copyright Copyright (c) 2016-2017 QCoreTeam (http://www.qcoreteam.org)
 * @license   http://www.topjs.org/license/new-bsd New BSD License
 */

TopJs.namespace("TopJs.servicemanager");

TopJs.require("TopJs.servicemanager.ServiceLocatorInterface");

/**
 * @alias TopJs.servicemanager.ServiceManager
 */
class ServiceManager extends TopJs.Class {
    constructor(config = {})
    {
        super();
        /**
         * @property {TopJs.servicemanager.Factory.AbstractFactoryInterface[]} abstractFactories
         */
        this.abstractFactories = [];

        /**
         * Whether or not changes may be made to this instance.
         *
         * @property {Boolean}
         */
        this.allowOverride = false;

        /**
         * @property {TopJs.servicemanager.ServiceLocatorInterface} creationContext
         */
        this.creationContext = null;

        /**
         *  A list of already loaded services (this act as a local cache)
         *
         * @property {Object} services
         */
        this.services = {};

        /**
         * A list of factories (either as string name or callable)
         *
         * @property {Object} factories
         */
        this.factories = {};

        /**
         * the alias to real class name map
         *
         * @property {Map} resolvedAliases
         */
        this.resolvedAliases = new Map();

        /**
         * Enable/disable shared instances by service name.
         *
         * @property {Object} shared
         */
        this.shared = {};

        /**
         * @property {String[][]|TopJs.servicemanager.Factory.DelegatorFactoryInterface[][]} delegators
         */
        this.delegators = {};

        /**
         * @property {TopJs.servicemanager.Initializer.InitializerInterface[]} initializers
         */
        this.initializers = [];

        /**
         * Should the services be shared by default?
         *
         * @property {Boolean} sharedByDefault
         */
        this.sharedByDefault = true;

        /**
         * Service manager was already configured?
         *
         * @property {Boolean} configured
         */
        this.configured = false;
        this.creationContext = this;
        this.configure(config);
    }

    get(name)
    {
        let requestedName = name;
        // We start by checking if we have cached the requested service (this
        // is the fastest method).
        if (this.services.hasOwnProperty(requestedName)) {
            return this.services[requestedName];
        }
        name = this.resolvedAliases.has(name) ? this.resolvedAliases.get(name) : name;
        // Next, if the alias should be shared, and we have cached the resolved
        // service, use it.
        if (requestedName !== name &amp;&amp; (!this.shared.hasOwnProperty(requestedName) || this.shared[requestedName])
            &amp;&amp; this.services.hasOwnProperty(name)) {
            this.services[requestedName] = this.services[name];
            return this.services[name];
        }
        // At this point, we need to create the instance; we use the resolved
        // name for that.
        let object = this.doCreate(name);
        // Cache it for later, if it is supposed to be shared.
        if ((this.sharedByDefault &amp;&amp; !this.shared.hasOwnProperty(name)) ||
            (this.shared.hasOwnProperty(name) &amp;&amp; this.shared[name])) {
            this.services[name] = object;
        }
        // Also do so for aliases; this allows sharing based on service name used.
        if (requestedName !== name &amp;&amp;
            ((this.sharedByDefault &amp;&amp; !this.shared.hasOwnProperty(requestedName)) ||
            (this.shared.hasOwnProperty(requestedName) &amp;&amp; this.shared[requestedName]))) {
            this.services[requestedName] = object;
        }
        return object;
    }

    /**
     * Create a new instance with an already resolved name
     *
     * This is a highly performance sensitive method, do not modify if you have not benchmarked it carefully
     *
     * @param {String} resolvedName
     * @param {null|array} options
     * @return mixed
     * @throws TopJs.Error
     */
    doCreate(resolvedName, options = null)
    {
        let object;
        try {
            if (!this.delegators.hasOwnProperty(resolvedName)) {
                // Let's create the service by fetching the factory
                let factory = this.getFactory(resolvedName);
                object = factory(this.creationContext, resolvedName, options);
            } else {
                object = this.createDelegatorFromName(resolvedName, options);
            }
        } catch (ex) {
            TopJs.raise(TopJs.sprintf(
                'Service with name "%s" could not be created. Reason: %s',
                resolvedName, ex.message));
        }
        this.initializers.forEach(function (initializer)
        {
            initializer.init(this.creationContext, object);
        });
        return object;
    }

    has(name)
    {

    }

    /**
     * Indicate whether or not the instance is immutable.
     *
     * @param {Boolean} flag
     * @return {TopJs.servicemanager.ServiceManager}
     */
    setAllowOverride(flag)
    {
        this.allowOverride = !!flag;
        return this;
    }

    /**
     * Retrieve the flag indicating immutability status.
     *
     * @return {Boolean}
     */
    getAllowOverride()
    {
        return this.allowOverride;
    }

    configure(config)
    {
        if (config.hasOwnProperty("services") &amp;&amp; !TopJs.isEmpty(config.services)) {
            this.services = TopJs.applyIf(config.services, this.services);
        }
        if (config.hasOwnProperty("invokables") &amp;&amp; !TopJs.isEmpty(config.invokables)) {
            let aliases = ServiceManager.createAliasesForInvokables(config.invokables);
            let factories = ServiceManager.createFactoriesForInvokables(config.invokables);
            if (!TopJs.isEmpty(aliases)) {
                config.aliases = config.hasOwnProperty("aliases") ?
                    TopJs.apply(config.aliases, aliases) : aliases;
            }
            config.factories = config.hasOwnProperty("factories") ?
                TopJs.apply(config.factories, factories) : factories;
        }
        if (config.hasOwnProperty("factories") &amp;&amp; !TopJs.isEmpty(config.factories)) {
            this.factories = TopJs.applyIf(config.factories, this.factories);
        }
        if (config.hasOwnProperty("delegators")) {
            this.delegators = TopJs.Object.merge(this.delegators, config.hasOwnProperty("delegators"));
        }
    }

    static createAliasesForInvokables(invokables)
    {
        let aliases = {};
        for (let [name, clsName] of Object.entries(invokables)) {
            if (name === clsName) {
                continue;
            }
            aliases[name] = clsName;
        }
        return aliases;
    }

    static createFactoriesForInvokables(invokables)
    {
        let factories = {};
        for (let [name, clsName] of Object.entries(invokables)) {
            factories[clsName] = "TopJs.servicemanager.factory.InvokableFactory";
        }
        return factories;
    }

    /**
     * Get a factory for the given service name
     *
     * @param {String} name
     * @return callable
     * @throws TopJs.Error
     */
    getFactory(name)
    {
        let factory = this.factories.hasOwnProperty(name) ? this.factories[name] : null;
        let lazyLoaded = false;
        if (TopJs.isString(factory) &amp;&amp; TopJs.classExists(factory)) {
            factory = TopJs.ClassManager.instanceByName(factory);
            lazyLoaded = true;
        }
        if (factory &amp;&amp; (TopJs.isFunction(factory) ||
            (factory.hasOwnProperty(factory) &amp;&amp; TopJs.isFunction(factory.invoke)))) {
            if (lazyLoaded) {
                this.factories[name] = factory;
            }
            return factory;
        }
        // Check abstract factories
        let length = this.abstractFactories.length;
        for (let i = 0; i &lt; length; i++) {
            let abstractFactory = this.abstractFactories[i];
            if (abstractFactory.canCareate(this.creationContext, name)) {
                return abstractFactory;
            }
        }
        TopJs.raise(TopJs.sprintf(
            'Unable to resolve service "%s" to a factory; are you certain you provided it during configuration?',
            name
        ));
    }
}


TopJs.implements(ServiceManager, TopJs.servicemanager.ServiceLocatorInterface);

TopJs.registerClass("TopJs.servicemanager.ServiceManager", ServiceManager);</code></pre>
        </article>
    </section>




    </div>
</div>



<script src="../js/jquery.min.js"></script>
<script src="../js/tether.min.js" crossorigin="anonymous"></script>



<script src="../js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="../js/linenumber.js"></script>
<script src="../js/maodian.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-light.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js"></script>
<script src="../js/extra.js"></script>
<script src="../js/common.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
