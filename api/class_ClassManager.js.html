<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>class/ClassManager.js - Documentation</title>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="../css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="../css/prettify.css">
    <link type="text/css" rel="stylesheet" href="../css/jsdoc.css">
    <link type="text/css" rel="stylesheet" href="../css/extra.css">
    <link type="text/css" rel="stylesheet" href="../css/common.css">
</head>
<body>
<header class="navbar navbar-fixed-top fixed-header fixed-header-active header hidden-sm-down">
    <nav class="navbar navbar-light">

        <div class="">
            <button class="navbar-toggler hidden-lg-up float-xs-right" type="button" data-toggle="collapse"
                    data-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"></button>
            <a href="/"><img class="navbar-brand logo" src="../images/logo-green.png"></a>

            <div class="collapse navbar-toggleable-md float-lg-right" id="navbarResponsive">
                <ul class="nav navbar-nav float-lg-right">
                    <li class="nav-item"><a class="nav-link" href="/" >首页</a></li><li class="nav-item"><a class="nav-link" href="/docs/v0.0.1/" >手册</a></li><li class="nav-item"><a class="nav-link" href="/api/" >API文档</a></li><li class="nav-item"><a class="nav-link" href="/categories/blog/" >博客</a></li><li class="nav-item"><a class="nav-link" href="/categories/devel/" >开发日志</a></li><li class="nav-item"><a class="nav-link" href="/about/" >关于我们</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="hidden-md-up sm-header">
    <div class="toggler" id="slideClose"></div>
    <img src="../images/logo-green.png">
</div>
<div class="api-container clearfix">
    <nav>
        <div class="category hidden-md-up">
            <a href="/">首页</a>
            <a href="/docs/v0.0.1/">手册</a>
            <a href="/api/">API文档</a>
            <a href="/categories/blog">博客</a>
            <a href="/categories/devel">开发日志</a>
            <a href="/about">关于我们</a>
        </div>
        <h3>Namespaces</h3><ul class = "entry-type-namespaces"><li><a href="TopJs.html">TopJs</a><ul class='members'><li data-type='member' class='entry-type-class'><a href="TopJs.Array.html">Array</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Assert.html">Assert</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Base.html">Base</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Class.html">Class</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.ClassManager.html">ClassManager</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Config.html">Config</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Date.html">Date</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Error.html">Error</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Function.html">Function</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Loader.html">Loader</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Number.html">Number</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Object.html">Object</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.String.html">String</a></li><li data-type='member' class='entry-type-class'><a href="TopJs.Version.html">Version</a></li></ul></li><li><a href="TopJs.kernel.html">TopJs.kernel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#callParent">callParent</a></li><li><a href="global.html#callSuper">callSuper</a></li><li><a href="global.html#clearPropertiesOnDestroy">clearPropertiesOnDestroy</a></li><li><a href="global.html#destroyed">destroyed</a></li><li><a href="global.html#isConfiguring">isConfiguring</a></li><li><a href="global.html#isFirstInstance">isFirstInstance</a></li><li><a href="global.html#isInstance">isInstance</a></li><li><a href="global.html#statics">statics</a></li></ul>
    </nav>
    <div id="main">
        
        <h1 class="page-title">class/ClassManager.js</h1>
        

        



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * TopJs Framework (http://www.topjs.org/)
 *
 * @link      http://github.com/qcoreteam/topjs for the canonical source repository
 * @copyright Copyright (c) 2016-2017 QCoreTeam (http://www.qcoreteam.org)
 * @license   http://www.topjs.org/license/new-bsd New BSD License
 */
"use strict";
require("./Config");
require("./Configurator");
require("./Base");
require("./Class");

let Class = TopJs.Class;
let makeCtor = Class.makeCtor;
let Manager = TopJs.ClassManager = {};
let nameLookupStack = [];
let namespaceCache = {
    TopJs: {
        name: 'TopJs',
        value: TopJs
    }
};
/**
 * @class TopJs.ClassManager
 * @singleton
 */
TopJs.apply(Manager, /** @lends TopJs.ClassManager */{
    /**
     * @property {Object} classes
     * 所有通过`TopJs.ClassManager`定义的类的集合，键是类的名称值是类对象
     * @private
     */
    classes: {},

    /*
     * 'TopJs.foo.Bar': &lt;state enum>
     *
     *  10 = Ext.define called
     *  20 = Ext.define/override called
     *  30 = Manager.existCache[&lt;name>] == true for define
     *  40 = Manager.existCache[&lt;name>] == true for define/override
     *  50 = Manager.isCreated(&lt;name>) == true for define
     *  60 = Manager.isCreated(&lt;name>) == true for define/override
     *
     */
    classState: {},

    /**
     * @private
     */
    existCache: {},

    /** @private */
    instantiators: [],

    /**
     * 检查一个类是否已经定义
     *
     * @param {String} className
     * @return {Boolean} `true`代表类已经定义
     */
    isCreated(className)
    {
        //&lt;debug>
        if (typeof className !== 'string' || className.length &lt; 1) {
            throw new Error("[TopJs.ClassManager] Invalid classname, must be a string and must not be empty");
        }
        //&lt;/debug>
        if (Manager.classes[className] || Manager.existCache[className]) {
            return true;
        }
        if (!Manager.lookupName(className, false)) {
            return false;
        }
        Manager.triggerCreated(className);
        return true;
    },

    /**
     * @private
     */
    createdListeners: [],

    /**
     * @private
     */
    nameCreatedListeners: {},

    /**
     * @private
     */
    existsListeners: [],

    /**
     * @private
     */
    nameExistsListeners: {},

    /**
     * @private
     * @param {String} className
     * @param {Number} state
     */
    triggerCreated (className, state)
    {
        Manager.existCache[className] = state || 1;
        Manager.classState[className] += 40;
        Manager.notify(className, Manager.createdListeners, Manager.nameCreatedListeners);
    },

    /**
     * @private
     */
    onCreate (fn, scope, className)
    {
        Manager.addListener(fn, scope, className, Manager.createdListeners,
            Manager.nameCreatedListeners);
    },

    /**
     * @private
     */
    notify(className, listeners, nameListeners)
    {
        let listener;
        for (let i = 0, len = listeners.length; i &lt; len; i++) {
            listener = listeners[i];
            listener.func.call(listener.scope, className);
        }
        let clsNamedListeners = nameListeners[className];
        if (clsNamedListeners) {
            for (let i = 0, len = listeners.length; i &lt; len; i++) {
                listener = listeners[ji];
                listener.func.call(listener.scope, name);
            }
            delete nameListeners.delete(name);
        }
    },

    /**
     * @private
     * @param {Function} func
     * @param {Object} scope
     * @param {String|String[]} className
     * @param {Array} listeners
     * @param {Object} nameListeners
     */
    addListener(func, scope, className, listeners, nameListeners)
    {
        if (TopJs.isArray(className)) {
            fn = TopJs.Function.createBarrier(className.length, func, scope);
            for (let i = 0; i &lt; className.length; i++) {
                this.addListener(func, null, className[i], listeners, nameListeners);
            }
        }
        let listener = {
            func: func,
            scope: scope
        };
        if (className) {
            if (this.isCreated(className)) {
                func.call(scope, className);
                return;
            }
            if (!nameListeners[className]) {
                nameListeners[className] = [];
            }
            nameListeners[className].push(listener);
        } else {
            listeners.push(listener);
        }
    },

    /**
     * Supports namespace rewriting.
     * @private
     */
    $_namespace_cache_$: namespaceCache,

    /**
     * See `{@link TopJs#addRootNamespaces Ext.TopJs}`.
     * @private
     */
    addRootNamespaces (namespaces)
    {
        for (let name in namespaces) {
            namespaceCache[name] = {
                name: name,
                value: namespaces[name]
            };
        }
    },

    /**
     * Clears the namespace lookup cache. After application launch, this cache can
     * often contain several hundred entries that are unlikely to be needed again.
     * These will be rebuilt as needed, so it is harmless to clear this cache even
     * if its results will be used again.
     * @private
     */
    clearNamespaceCache()
    {
        nameLookupStack.length = 0;
        for (let name in namespaceCache) {
            if (!namespaceCache[name].value) {
                delete namespaceCache[name];
            }
        }
    },

    /**
     * Return the namespace cache entry for the given a class name or namespace
     *
     * @param {String} namespace The namespace or class name to lookup.
     * @return {Object} The cache entry.
     * @return {String} return.name The leaf name
     * @return {Object} return.parent The entry of the parent namespace
     * @return {Object} return.value The namespace object. This is only set for
     * top-level namespace entries to support renaming them for sandboxing
     * @private
     */
    getNamespaceEntry(namespace)
    {
        if (typeof namespace !== 'string') {
            return namespace;  // assume we've been given an entry object
        }
        let entry = namespaceCache[namespace];
        let i;
        if (!entry) {
            i = namespace.lastIndexOf('.');
            if (i &lt; 0) {
                entry = {
                    name: namespace
                };
            } else {
                entry = {
                    name: namespace.substring(i + 1),
                    parent: Manager.getNamespaceEntry(namespace.substring(0, i))
                };
            }
            namespaceCache[namespace] = entry;
        }
        return entry;
    },

    /**
     * Return the value of the given "dot path" name. This supports remapping (for use
     * in sandbox builds) as well as auto-creating of namespaces.
     *
     * @param {String} namespace The name of the namespace or class.
     * @param {Boolean} [autoCreate] Pass `true` to create objects for undefined names.
     * @return {Object} The object that is the namespace or class name.
     * @private
     */
    lookupName: function (namespace, autoCreate = true)
    {
        let entry = Manager.getNamespaceEntry(namespace);
        let scope = TopJs.global;
        let parent;
        let i = 0;
        let e;
        // Put entries on the stack in reverse order: 
        // TopJs.Some.Class => ["Class", "Some", "TopJs"]
        for (e = entry; e; e = e.parent) {
            // since we process only what we add to the array, and that always
            // starts at index=0, we don't need to clean up the array (that would
            // just encourage the GC to do something pointless).
            nameLookupStack[i++] = e;
        }
        
        while (scope &amp;&amp; i-- > 0) {
            // We'll process entries in top-down order ("TopJs", "Some" then "Class").
            e = nameLookupStack[i];
            parent = scope;
            scope = e.value || scope[e.name];
            if (!scope &amp;&amp; autoCreate) {
                parent[e.name] = scope = {};
            }
        }
        return scope;
    },

    /**
     * Creates a namespace and assign the `value` to the created object.
     *
     *     TopJs.ClassManager.setNamespace('MyCompany.pkg.Example', someObject);
     *
     *     console.log(MyCompany.pkg.Example === someObject); // console true
     *
     * @param {String} namespace
     * @param {Object} value
     */
    setNamespace (namespace, value)
    {
        let entry = Manager.getNamespaceEntry(namespace);
        let scope = TopJs.global;

        if (entry.parent) {
            scope = Manager.lookupName(entry.parent, true);
        }
        scope[entry.name] = value;
        return value;
    },

    /**
     * @param {String} className
     * @param {Object} data
     * @param {Function} createdFunc
     */
    create(className, data, createdFunc)
    {
        //&lt;debug>
        if (className != null &amp;&amp; typeof className !== 'string') {
            throw new Error("[TopJs.define] Invalid class name '" + className + "' specified, must be a non-empty string");
        }
        //&lt;/debug>
        let ctor = makeCtor(className);
        if (typeof data === 'function') {
            data = data(ctor);
        }
        //&lt;debug>
        if (className) {
            if (Manager.classes[className]) {
                TopJs.log.warn("[TopJs.define] Duplicate class name '" + className + "' specified, must be a non-empty string");
            }
        }
        //&lt;/debug>
        data.$_class_name_$ = className;
        return new Class(ctor, data, function ()
        {

        });
    }
});

TopJs.apply(TopJs, /** @lends TopJs */{
    define(className, data, createdFunc)
    {
        //&lt;debug>
        TopJs.classSystemMonitor &amp;&amp; Ext.classSystemMonitor(className, 'ClassManager#define', arguments);
        //&lt;/debug>
        if (data.override) {
            Manager.classState[className] = 20;
            return Manager.createOverride.apply(Manager, arguments);
        }
        Manager.classState[className] = 10;
        return Manager.create.apply(Manager, arguments);
    }
});</code></pre>
        </article>
    </section>




    </div>
</div>



<script src="../js/jquery.min.js"></script>
<script src="../js/tether.min.js" crossorigin="anonymous"></script>

<script src="../js/prettify/prettify.js"></script>
<script src="../js/prettify/lang-css.js"></script>
<script>prettyPrint();</script>

<script src="../js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="../js/linenumber.js"></script>
<script src="../js/maodian.js"></script>

<script src="../js/extra.js"></script>
<script src="../js/common.js"></script>
</body>
</html>
